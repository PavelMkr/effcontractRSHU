<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Функция для отображения уведомлений
        function showNotification(message, isError = false) {
            var notification = $('#notification');
            notification.text(message);

            // Добавляем класс в зависимости от типа уведомления (ошибки или успеха)
            if (isError) {
                notification.addClass('error');
            } else {
                notification.removeClass('error');
            }

            // Плавно показываем и скрываем уведомление
            notification.fadeIn(500).delay(3000).fadeOut(500);
        }
</script>

{{!-- Скрипты страницы, если это декан и/или директор --}}
{{#if isDekaDir}}  
{{/if}}
    
{{!-- Скрипты страницы, если это завкафедры --}}
{{#if isZavKaf}} 
{{/if}}
    
{{!-- Скрипты страницы, если это преподаватель  --}}
{{#if isPrepod}}
<script>
     // Скрипт загрузки файлов
    $(document).ready(function() {
        // Обработчик события клика на кнопку "Отправить"
        $('input[name="uploadBtn"]').click(function(event) {
            event.preventDefault(); // Предотвращаем стандартное поведение кнопки

            // Создаем объект FormData для всех файлов
            var formData = new FormData();

            // Цикл по каждому элементу с классом file-input
            $('.file-input').each(function() {
                var files = $(this)[0].files;

                // Добавляем файлы и информацию о них в formData
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    var index = $(this).data('index');
                    var idInput = $(this).data('id-input');
                    var idResult = $(this).data('result-id');
                    var count = $('#first' + idResult).val(); // Получаем значение поля ввода
                    var point = $('#result' + idResult).text(); // Получаем текстовое содержимое элемента
                    console.log(
                        file, 
                        index, 
                        idInput, 
                        idResult,
                        count, 
                        point 
                    );

                    formData.append('files[]', file);
                    formData.append('index[]', index);
                    formData.append('id_input[]', idInput);
                    formData.append('first[]', count);
                    formData.append('result[]', point);
                }
            });

            // Отправляем AJAX запрос на сервер
            $.ajax({
                url: '/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    // Отображаем уведомление на странице
                    showNotification(response.message);
                },
                error: function(xhr, status, error) {
                    // Отображаем уведомление о ошибке
                    showNotification('Ошибка загрузки файла: ' + error, true);
                    $('input[name="files[]"]').val(''); // Очистка инпутов
                }
            });
        });
    });

    // Сумма баллов
    function mult(second,first,result) {
        second.value = second
        var first = document.getElementById(first).value;
        document.getElementById(result).innerHTML = first * second;
    }

    function sumballAll() {
        var res ='result';
        let i = 1
        var names= [];
        while (i < 80) {
        name = res+i;
        var chislo = document.getElementById(name).textContent;
        names.push(chislo); 
        i++;
    }	
        var sum = 0
        for(var j = 0; j < names.length; j++){
        names[j]=Number(names[j])
        sum += names[j];
        }
        document.getElementById("result").innerText = sum;
    }
</script>
{{/if}}

{{!-- Скрипты страницы, если это админ --}}
{{#if isAdmin}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
<script>
    function filter(input, tableId) {
        var searchText = input.value.toLowerCase();
        var table = document.getElementById(tableId);
        var rows = table.getElementsByTagName('tr');

        for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].getElementsByTagName('td');
            var found = false;
            for (var j = 0; j < cells.length; j++) {
                var cellText = cells[j].textContent.toLowerCase();
                if (cellText.indexOf(searchText) > -1) {
                    found = true;
                    break;
                }
            }
            if (found) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }

</script>

    {{#if isUserEk}}
        <script>
            document.getElementById('confirmButton').addEventListener('click', async function() {
                var checkboxes = document.getElementsByName('confirmEK');
                var selectedIds = [];

                // Проверяем, какие checkbox'ы выбраны
                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) {
                        selectedIds.push(checkboxes[i].id.substring(7));
                    }
                }
                console.log(selectedIds);
                console.log(selectedIds.length);

                if (selectedIds.length == 0) {
                    showNotification('Выберите значение', true);
                    return;
                }

                try {
                    // Выполняем запрос к серверу для обновления данных в БД
                    const response = await fetch('/confirmDocuments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(selectedIds),
                    });
                    console.log(JSON.stringify(selectedIds));

                    const data = await response.json();

                    if (data.success) {
                        showNotification('Данные успешно обновлены');
                    } else {
                        showNotification(data.message, true);
                    }
                } catch (error) {
                    console.error('Ошибка при выполнении запроса:', error);
                    showNotification('Произошла ошибка', true);
                }
            });
        </script>
    {{/if}}
{{/if}}